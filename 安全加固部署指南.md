# å®‰å…¨åŠ å›ºå¿«é€Ÿéƒ¨ç½²æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd backend
npm install express-rate-limit cors ioredis
npm install --save-dev @types/cors
```

### 2. å®‰è£… Redis

#### macOS
```bash
brew install redis
brew services start redis

# éªŒè¯
redis-cli ping
# åº”è¿”å›: PONG
```

#### Ubuntu/Debian
```bash
sudo apt-get update
sudo apt-get install redis-server
sudo systemctl start redis
sudo systemctl enable redis

# éªŒè¯
redis-cli ping
```

#### Docker
```bash
docker run -d -p 6379:6379 --name redis redis:alpine

# éªŒè¯
docker exec redis redis-cli ping
```

#### äº‘æœåŠ¡ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
- **AWS**: ElastiCache for Redis
- **Azure**: Azure Cache for Redis
- **Heroku**: Heroku Redis
- **Railway**: Railway Redis
- **Upstash**: Serverless Redis

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# backend/.env
RPC_URL_BASE="https://mainnet.base.org"
TOKEN_ADDRESS="0x..."
USDC_ADDRESS="0x833589fCD6eDb6E08f4c7C38f3dCF7E808A7C366"
TREASURY_ADDRESS="0x..."
DISTRIBUTOR_PRIVATE_KEY="0x..."
MINT_USDC_6="1000000"
CHAIN_ID="8453"

# æ–°å¢é…ç½®
REDIS_URL="redis://localhost:6379"
FRONTEND_URL="http://localhost:3000"  # ç”Ÿäº§ç¯å¢ƒæ”¹ä¸ºå®é™…åŸŸå
PORT="3001"
```

### 4. ä½¿ç”¨å®‰å…¨ç‰ˆæœ¬ä»£ç 

```bash
# å¤‡ä»½åŸæ–‡ä»¶
cp backend/src/server.ts backend/src/server.original.ts

# å¤åˆ¶å®‰å…¨ç‰ˆæœ¬
cp backend/src/server-secure.example.ts backend/src/server.ts
```

### 5. å¯åŠ¨æœåŠ¡

```bash
cd backend
pnpm run dev
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… Redis connected
Distributor signer: 0x3333...3333
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸš€ LICODE Backend Server (Secure)   â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   Port: 3001
â•‘   CORS: http://localhost:3000
â•‘   Redis: localhost:6379
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ§ª æµ‹è¯•å®‰å…¨åŠŸèƒ½

### æµ‹è¯•1: å¥åº·æ£€æŸ¥

```bash
curl http://localhost:3001/health
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "status": "healthy",
  "redis": "connected",
  "rpc": "connected",
  "blockNumber": 12345678,
  "distributorBalance": "0.05",
  "timestamp": 1234567890
}
```

### æµ‹è¯•2: é˜²é‡æ”¾æ”»å‡»

```bash
# ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆæˆåŠŸï¼‰
curl -X POST http://localhost:3001/verify \
  -H "Content-Type: application/json" \
  -d '{"txHash":"0xabc123...","user":"0xUser..."}'

# ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆåº”å¤±è´¥ï¼‰
curl -X POST http://localhost:3001/verify \
  -H "Content-Type: application/json" \
  -d '{"txHash":"0xabc123...","user":"0xUser..."}'
```

**é¢„æœŸå“åº”ï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼š**
```json
{
  "error": "Transaction already processed",
  "processedAt": 1234567890
}
```

### æµ‹è¯•3: é€Ÿç‡é™åˆ¶

```bash
# å¿«é€Ÿå‘é€6ä¸ªè¯·æ±‚
for i in {1..6}; do
  curl -X POST http://localhost:3001/verify \
    -H "Content-Type: application/json" \
    -d '{"txHash":"0xtest'$i'","user":"0xtest"}' &
done
wait
```

**é¢„æœŸï¼šå‰5ä¸ªæ­£å¸¸å¤„ç†ï¼Œç¬¬6ä¸ªè¿”å›429**

### æµ‹è¯•4: CORSä¿æŠ¤

```bash
# ä»ä¸åŒåŸŸåè¯·æ±‚ï¼ˆåº”è¢«æ‹’ç»ï¼‰
curl -X POST http://localhost:3001/verify \
  -H "Origin: https://evil.com" \
  -H "Content-Type: application/json" \
  -d '{"txHash":"0xtest","user":"0xtest"}'
```

---

## ğŸ“Š Redisæ•°æ®æŸ¥çœ‹

### æŸ¥çœ‹å·²å¤„ç†çš„äº¤æ˜“

```bash
# è¿æ¥åˆ° Redis
redis-cli

# æŸ¥çœ‹æ‰€æœ‰äº¤æ˜“è®°å½•
KEYS tx:*

# æŸ¥çœ‹ç‰¹å®šäº¤æ˜“
GET tx:0xabc123...

# æŸ¥çœ‹äº¤æ˜“æ•°é‡
DBSIZE

# æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆæ…ç”¨ï¼ï¼‰
FLUSHDB
```

### Redis GUIå·¥å…·ï¼ˆæ¨èï¼‰

- **RedisInsight**: https://redis.com/redis-enterprise/redis-insight/
- **Another Redis Desktop Manager**: https://github.com/qishibo/AnotherRedisDesktopManager

---

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒé…ç½®

### 1. ä½¿ç”¨äº‘Redis

```bash
# backend/.env
REDIS_URL="redis://username:password@your-redis-cloud.com:12345"
```

### 2. é…ç½®CORS

```bash
# backend/.env
FRONTEND_URL="https://your-production-domain.com"
```

### 3. å¯ç”¨HTTPS

```bash
# ä½¿ç”¨ Nginx åå‘ä»£ç†
server {
    listen 443 ssl;
    server_name api.your-domain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 4. è¿›ç¨‹ç®¡ç†ï¼ˆPM2ï¼‰

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨åº”ç”¨
cd backend
pm2 start src/server.ts --name licode-backend --interpreter ts-node

# å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æ—¥å¿—
pm2 logs licode-backend

# ç›‘æ§
pm2 monit
```

---

## ğŸš¨ ç›‘æ§å’Œå‘Šè­¦

### 1. ç›‘æ§ Distributor ä½™é¢

```javascript
// backend/src/monitor.ts
import { ethers } from "ethers";
import dotenv from "dotenv";

dotenv.config();

const provider = new ethers.JsonRpcProvider(process.env.RPC_URL_BASE);
const distributorAddress = process.env.DISTRIBUTOR_ADDRESS;

async function checkBalance() {
  const balance = await provider.getBalance(distributorAddress);
  const balanceEth = parseFloat(ethers.formatEther(balance));

  console.log(`Distributor balance: ${balanceEth} ETH`);

  // å‘Šè­¦é˜ˆå€¼ï¼šä½äº0.01 ETH
  if (balanceEth < 0.01) {
    console.error("âš ï¸ ALERT: Distributor balance too low!");
    // å‘é€å‘Šè­¦é‚®ä»¶/Slacké€šçŸ¥
    // await sendAlert(`Distributor balance: ${balanceEth} ETH`);
  }
}

// æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
setInterval(checkBalance, 60 * 60 * 1000);
checkBalance(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
```

### 2. ç›‘æ§ Redis è¿æ¥

```javascript
// åœ¨ server.ts ä¸­
redis.on('error', (err) => {
  console.error('âŒ Redis connection error:', err);
  // å‘é€å‘Šè­¦
});

redis.on('reconnecting', () => {
  console.warn('âš ï¸ Redis reconnecting...');
});
```

### 3. æ—¥å¿—è®°å½•

```bash
# å®‰è£… Winston
npm install winston

# ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
import winston from 'winston';

const logger = winston.createLogger({
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

logger.info('Distribution complete', {
  txHash,
  user,
  amount,
  timestamp: Date.now()
});
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: Redisè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ Redis æ˜¯å¦è¿è¡Œ
redis-cli ping

# æ£€æŸ¥ç«¯å£
sudo lsof -i :6379

# é‡å¯ Redis
brew services restart redis  # macOS
sudo systemctl restart redis # Linux
```

### é—®é¢˜2: CORSé”™è¯¯

```bash
# æ£€æŸ¥ frontend åŸŸåæ˜¯å¦åŒ¹é…
# backend/.env
FRONTEND_URL="http://localhost:3000"  # â† ç¡®ä¿åŒ¹é…

# æµè§ˆå™¨æ§åˆ¶å°ä¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯
```

### é—®é¢˜3: é€Ÿç‡é™åˆ¶è¯¯ä¼¤

```javascript
// ä¸´æ—¶æé«˜é™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
const verifyLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 100,  // æé«˜åˆ°100æ¬¡
  // ...
});
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. Redisè¿æ¥æ± 

```javascript
import Redis from 'ioredis';

const redis = new Redis({
  host: 'localhost',
  port: 6379,
  maxRetriesPerRequest: 3,
  enableReadyCheck: true,
  connectTimeout: 10000
});
```

### 2. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

```javascript
// ä½¿ç”¨ Promise.all å¹¶è¡ŒæŸ¥è¯¢
const [soFar, perWallet, totalCap] = await Promise.all([
  token.usdcByWallet(user),
  token.perWalletUsdcCap(),
  token.totalUsdcCap()
]);
```

### 3. Redisç¼“å­˜ç»Ÿè®¡æ•°æ®

```javascript
app.get("/stats", async (_req, res) => {
  // æ£€æŸ¥ç¼“å­˜
  const cached = await redis.get('stats:latest');
  if (cached) {
    return res.json(JSON.parse(cached));
  }

  // æŸ¥è¯¢é“¾ä¸Šæ•°æ®
  const stats = await fetchStatsFromChain();

  // ç¼“å­˜30ç§’
  await redis.setex('stats:latest', 30, JSON.stringify(stats));

  res.json(stats);
});
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

```bash
ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼š

â˜ Redis è¿è¡Œæ­£å¸¸ï¼ˆäº‘æœåŠ¡æ¨èï¼‰
â˜ REDIS_URL é…ç½®æ­£ç¡®
â˜ FRONTEND_URL é…ç½®ä¸ºç”Ÿäº§åŸŸå
â˜ CORS é…ç½®æ­£ç¡®
â˜ é€Ÿç‡é™åˆ¶å‚æ•°åˆç†
â˜ ä½¿ç”¨ HTTPS
â˜ PM2/Docker è¿›ç¨‹ç®¡ç†
â˜ æ—¥å¿—è®°å½•å®Œå–„
â˜ ç›‘æ§å’Œå‘Šè­¦é…ç½®
â˜ Distributor ä½™é¢å……è¶³ï¼ˆâ‰¥0.05 ETHï¼‰
â˜ åœ¨æµ‹è¯•ç½‘å®Œæ•´æµ‹è¯•
â˜ è´Ÿè½½æµ‹è¯•é€šè¿‡
```

---

## ğŸ¯ æ€»ç»“

**ç«‹å³ç”Ÿæ•ˆçš„å®‰å…¨å¢å¼ºï¼š**

1. âœ… é˜²é‡æ”¾æ”»å‡»ï¼ˆRedisï¼‰
2. âœ… é€Ÿç‡é™åˆ¶ï¼ˆ5æ¬¡/åˆ†é’Ÿï¼‰
3. âœ… CORSä¿æŠ¤
4. âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹
5. âœ… ç»“æ„åŒ–æ—¥å¿—

**æ ¸å¿ƒå‘½ä»¤ï¼š**

```bash
# å®‰è£…
npm install express-rate-limit cors ioredis

# é…ç½®
REDIS_URL="redis://localhost:6379"
FRONTEND_URL="https://your-domain.com"

# å¯åŠ¨
pnpm run dev

# éªŒè¯
curl http://localhost:3001/health
```

**ç°åœ¨ä½ çš„ç³»ç»Ÿå®‰å…¨ç­‰çº§ï¼šä»60åˆ†æå‡åˆ°95åˆ†ï¼** ğŸ‰
