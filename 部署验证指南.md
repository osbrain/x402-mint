# å®‰å…¨åŠ å›ºéƒ¨ç½²éªŒè¯æŒ‡å—

## âœ… å·²å®Œæˆçš„æ­¥éª¤

1. âœ… å®‰è£…ä¾èµ–åŒ…ï¼ˆexpress-rate-limit, cors, ioredis, @types/corsï¼‰
2. âœ… å¤‡ä»½åŸæœåŠ¡å™¨ä»£ç ï¼ˆbackend/src/server.original.tsï¼‰
3. âœ… éƒ¨ç½²å®‰å…¨åŠ å›ºç‰ˆæœ¬ï¼ˆbackend/src/server.tsï¼‰

## ğŸš€ å¯åŠ¨å’ŒéªŒè¯æ­¥éª¤

### æ­¥éª¤1: é…ç½®ç¯å¢ƒå˜é‡

```bash
cd backend

# å¦‚æœè¿˜æ²¡æœ‰.envæ–‡ä»¶ï¼Œä»ç¤ºä¾‹å¤åˆ¶
cp .env.example .env

# æˆ–ä½¿ç”¨æ–°çš„å®‰å…¨é…ç½®æ¨¡æ¿
cp .env.secure.example .env

# ç¼–è¾‘.envæ–‡ä»¶ï¼Œè‡³å°‘æ·»åŠ ä»¥ä¸‹æ–°é…ç½®ï¼š
```

**æœ€å°é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒ - ä¸éœ€è¦Redisï¼‰ï¼š**
```bash
# backend/.env

# åŸæœ‰é…ç½®ï¼ˆå¿…éœ€ï¼‰
RPC_URL_BASE="https://sepolia.base.org"  # æµ‹è¯•ç½‘
TOKEN_ADDRESS="0x..."  # éƒ¨ç½²åå¡«å†™
USDC_ADDRESS="0x036CbD53842c5426634e7929541eC2318f3dCF7e"  # Base Sepolia USDC
TREASURY_ADDRESS="0x..."
DISTRIBUTOR_PRIVATE_KEY="0x..."
MINT_USDC_6="1000000"
CHAIN_ID="84532"

# æ–°å¢ï¼šå¯é€‰é…ç½®
# REDIS_URL="redis://localhost:6379"  # ä¸é…ç½®åˆ™ç¦ç”¨é˜²é‡æ”¾
ENABLE_CORS="false"  # å¼€å‘ç¯å¢ƒå¯ä»¥å…³é—­
ENABLE_RATE_LIMIT="true"  # ä¿æŒå¯ç”¨
FRONTEND_URL="http://localhost:3000"
```

### æ­¥éª¤2: å¯åŠ¨åç«¯ï¼ˆæ— Redisæµ‹è¯•ï¼‰

```bash
# åœ¨ backend ç›®å½•
pnpm run dev
```

**é¢„æœŸè¾“å‡ºï¼š**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸš€ LICODE Backend Server            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   Port: 3001
â•‘   Redis: DISABLED âš ï¸
â•‘   Rate Limit: enabled
â•‘   CORS: disabled
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ WARNING: Redis not configured - replay protection DISABLED!
   Set REDIS_URL environment variable to enable security
Distributor signer: 0x...
```

**âœ… å¦‚æœçœ‹åˆ°è¿™ä¸ªè¾“å‡ºï¼Œè¯´æ˜åŸºç¡€åŠŸèƒ½æ­£å¸¸ï¼**

### æ­¥éª¤3: æµ‹è¯•åŸºæœ¬åŠŸèƒ½

åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•ï¼š

```bash
cd backend
ts-node test-security.ts
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ğŸ§ª å¼€å§‹å®‰å…¨åŠŸèƒ½æµ‹è¯•...

1ï¸âƒ£ æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹...
âœ… å¥åº·æ£€æŸ¥æˆåŠŸ:
{
  "status": "degraded",  // Redisæœªå¯ç”¨æ—¶æ˜¾ç¤ºdegraded
  "timestamp": ...,
  "redis": "disabled",
  "rpc": "connected",
  "blockNumber": ...,
  "distributorBalance": "0.05"
}

2ï¸âƒ£ æµ‹è¯• /mint ç«¯ç‚¹...
âœ… /mint è¿”å› 402 æ­£ç¡®

3ï¸âƒ£ æµ‹è¯• /stats ç«¯ç‚¹...
âœ… /stats æˆåŠŸè¿”å›

4ï¸âƒ£ æµ‹è¯•é˜²é‡æ”¾æ”»å‡»...
âš ï¸ é˜²é‡æ”¾æ”»å‡»å¯èƒ½æœªå¯ç”¨ï¼ˆRedisæœªé…ç½®ï¼Ÿï¼‰

5ï¸âƒ£ æµ‹è¯•é€Ÿç‡é™åˆ¶...
âœ… é€Ÿç‡é™åˆ¶æ­£å¸¸å·¥ä½œï¼

6ï¸âƒ£ æµ‹è¯•åœ°å€éªŒè¯...
âœ… åœ°å€éªŒè¯æ­£å¸¸å·¥ä½œï¼

ğŸ“Š æµ‹è¯•å®Œæˆ: 6 é€šè¿‡, 0 å¤±è´¥
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å®‰å…¨åŠ å›ºéƒ¨ç½²æˆåŠŸï¼
```

### æ­¥éª¤4: ï¼ˆå¯é€‰ï¼‰å¯ç”¨Redisé˜²é‡æ”¾ä¿æŠ¤

#### 4.1 å®‰è£…Redis

**macOS:**
```bash
brew install redis
brew services start redis

# éªŒè¯
redis-cli ping  # åº”è¿”å› PONG
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt-get update
sudo apt-get install redis-server
sudo systemctl start redis
sudo systemctl enable redis

# éªŒè¯
redis-cli ping
```

**Docker:**
```bash
docker run -d -p 6379:6379 --name redis redis:alpine

# éªŒè¯
docker exec redis redis-cli ping
```

#### 4.2 é…ç½®Redis URL

```bash
# backend/.env
REDIS_URL="redis://localhost:6379"
```

#### 4.3 é‡å¯åç«¯

```bash
# Ctrl+C åœæ­¢ç°æœ‰æœåŠ¡
pnpm run dev
```

**é¢„æœŸè¾“å‡ºï¼ˆå¯ç”¨Redisåï¼‰ï¼š**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸš€ LICODE Backend Server            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   Port: 3001
â•‘   Redis: enabled  â† æ³¨æ„è¿™é‡Œ
â•‘   Rate Limit: enabled
â•‘   CORS: disabled
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Redis connected  â† æˆåŠŸè¿æ¥
Distributor signer: 0x...
```

#### 4.4 å†æ¬¡è¿è¡Œæµ‹è¯•

```bash
ts-node test-security.ts
```

**é¢„æœŸè¾“å‡ºï¼ˆå¯ç”¨Redisåï¼‰ï¼š**
```
4ï¸âƒ£ æµ‹è¯•é˜²é‡æ”¾æ”»å‡»...
  ç¬¬ä¸€æ¬¡è¯·æ±‚çŠ¶æ€: 400 - tx not confirmed
  ç¬¬äºŒæ¬¡è¯·æ±‚çŠ¶æ€: 400 - Transaction already processed  â† é˜²é‡æ”¾ç”Ÿæ•ˆï¼
âœ… é˜²é‡æ”¾æ”»å‡»æ­£å¸¸å·¥ä½œï¼
```

### æ­¥éª¤5: å‰åç«¯è”è°ƒæµ‹è¯•

#### 5.1 å¯åŠ¨å‰ç«¯

```bash
# åœ¨æ–°ç»ˆç«¯
cd frontend
pnpm run dev
```

#### 5.2 è®¿é—®å‰ç«¯

æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:3000`

**éªŒè¯æ¸…å•ï¼š**
- [ ] é¡µé¢åŠ è½½æ­£å¸¸
- [ ] å¯ä»¥çœ‹åˆ°ç»Ÿè®¡æ•°æ®ï¼ˆMint Progressï¼‰
- [ ] ç‚¹å‡» "Mint" æŒ‰é’®è¿”å› 402 çŠ¶æ€
- [ ] Contract Information æ˜¾ç¤ºæ­£ç¡®çš„åœ°å€

#### 5.3 æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰CORSé”™è¯¯ï¼š

**å¦‚æœæœ‰CORSé”™è¯¯ï¼š**
```bash
# backend/.env
ENABLE_CORS="true"
FRONTEND_URL="http://localhost:3000"

# é‡å¯åç«¯
```

## ğŸ” åŠŸèƒ½éªŒè¯æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½ï¼ˆæ— Redisï¼‰
- [ ] æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
- [ ] GET /health è¿”å›å¥åº·çŠ¶æ€
- [ ] GET /mint è¿”å› 402 çŠ¶æ€ç 
- [ ] GET /stats è¿”å›ç»Ÿè®¡æ•°æ®
- [ ] POST /verify éªŒè¯åœ°å€æ ¼å¼
- [ ] é€Ÿç‡é™åˆ¶æ­£å¸¸å·¥ä½œï¼ˆ5æ¬¡/åˆ†é’Ÿï¼‰

### å¢å¼ºåŠŸèƒ½ï¼ˆæœ‰Redisï¼‰
- [ ] Redisè¿æ¥æˆåŠŸ
- [ ] é˜²é‡æ”¾æ”»å‡»ç”Ÿæ•ˆ
- [ ] /health æ˜¾ç¤º "redis": "connected"

### å‰åç«¯é›†æˆ
- [ ] å‰ç«¯å¯ä»¥è®¿é—® /api/mint
- [ ] å‰ç«¯å¯ä»¥è®¿é—® /api/stats
- [ ] æ— CORSé”™è¯¯

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: Redisè¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âŒ Redis error: connect ECONNREFUSED 127.0.0.1:6379
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨Redis
brew services start redis  # macOS
sudo systemctl start redis  # Linux

# æˆ–ä¸´æ—¶ç¦ç”¨Redis
# backend/.env
# REDIS_URL=""  # æ³¨é‡Šæ‰æˆ–åˆ é™¤è¿™è¡Œ
```

### é—®é¢˜2: ç«¯å£å·²è¢«å ç”¨

**ç—‡çŠ¶ï¼š**
```
Error: listen EADDRINUSE: address already in use :::3001
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -ti:3001

# æ€æ­»è¿›ç¨‹
kill -9 $(lsof -ti:3001)

# æˆ–æ›´æ¢ç«¯å£
# backend/.env
PORT="3002"
```

### é—®é¢˜3: RPCè¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
Error: could not detect network
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥RPC_URLæ˜¯å¦æ­£ç¡®
# backend/.env
RPC_URL_BASE="https://sepolia.base.org"  # ç¡®ä¿URLæ­£ç¡®

# æˆ–ä½¿ç”¨å…¶ä»–RPCæä¾›å•†
# Alchemy: https://base-sepolia.g.alchemy.com/v2/YOUR_API_KEY
# Infura: https://base-sepolia.infura.io/v3/YOUR_API_KEY
```

### é—®é¢˜4: Distributorä½™é¢ä¸è¶³

**ç—‡çŠ¶ï¼š**
```
warning: "Distributor balance low"
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç»™distributoråœ°å€å……å€¼ETHï¼ˆæµ‹è¯•ç½‘å¯ç”¨æ°´é¾™å¤´ï¼‰
# Base Sepoliaæ°´é¾™å¤´: https://www.coinbase.com/faucets/base-ethereum-sepolia-faucet

# æ£€æŸ¥ä½™é¢
# è®¿é—® http://localhost:3001/health
```

## ğŸ“Š å¯¹æ¯”ï¼šåŠ å›ºå‰ vs åŠ å›ºå

| åŠŸèƒ½ | åŠ å›ºå‰ | åŠ å›ºå |
|------|--------|--------|
| é˜²é‡æ”¾æ”»å‡» | âŒ æ—  | âœ… Redisè®°å½• |
| é€Ÿç‡é™åˆ¶ | âŒ æ—  | âœ… 5æ¬¡/åˆ†é’Ÿ |
| CORSä¿æŠ¤ | âŒ æ—  | âœ… å¯é…ç½® |
| åœ°å€éªŒè¯ | âš ï¸ åŸºæœ¬ | âœ… ethers.isAddress |
| å¥åº·æ£€æŸ¥ | âŒ æ—  | âœ… /healthç«¯ç‚¹ |
| é”™è¯¯å¤„ç† | âš ï¸ åŸºæœ¬ | âœ… Rediså®¹é”™ |
| ä¼˜é›…å…³é—­ | âŒ æ—  | âœ… SIGTERMå¤„ç† |

## âœ… ç”Ÿäº§éƒ¨ç½²æ¸…å•

åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼Œç¡®ä¿ï¼š

- [ ] Rediså·²é…ç½®ï¼ˆäº‘Redisæ¨èï¼‰
- [ ] REDIS_URLä½¿ç”¨ç”Ÿäº§Redisåœ°å€
- [ ] FRONTEND_URLè®¾ç½®ä¸ºå®é™…åŸŸå
- [ ] ENABLE_CORS="true"
- [ ] ENABLE_RATE_LIMIT="true"
- [ ] USDC_ADDRESSä½¿ç”¨ä¸»ç½‘åœ°å€ï¼ˆ0x833589...ï¼‰
- [ ] CHAIN_ID="8453"ï¼ˆBaseä¸»ç½‘ï¼‰
- [ ] ä½¿ç”¨HTTPSï¼ˆNginx/Cloudflareï¼‰
- [ ] ä½¿ç”¨PM2/Dockerç®¡ç†è¿›ç¨‹
- [ ] é…ç½®ç›‘æ§å’Œå‘Šè­¦
- [ ] Distributorä½™é¢å……è¶³ï¼ˆâ‰¥0.1 ETHï¼‰

## ğŸ‰ æˆåŠŸæ ‡å¿—

å¦‚æœä»¥ä¸‹æ‰€æœ‰é¡¹ç›®éƒ½æ­£å¸¸ï¼Œè¯´æ˜å®‰å…¨åŠ å›ºæˆåŠŸï¼š

1. âœ… æœåŠ¡å™¨å¯åŠ¨æ— é”™è¯¯
2. âœ… test-security.ts å…¨éƒ¨æµ‹è¯•é€šè¿‡
3. âœ… å‰ç«¯å¯ä»¥æ­£å¸¸è®¿é—®åç«¯API
4. âœ… Redisè¿æ¥æ­£å¸¸ï¼ˆå¦‚æœå¯ç”¨ï¼‰
5. âœ… é€Ÿç‡é™åˆ¶æ­£å¸¸å·¥ä½œ
6. âœ… åœ°å€éªŒè¯æ­£å¸¸å·¥ä½œ

**æ­å–œï¼å®‰å…¨åŠ å›ºéƒ¨ç½²å®Œæˆï¼** ğŸ‰

## ğŸ“ å›æ»šæ–¹æ¡ˆ

å¦‚æœé‡åˆ°é—®é¢˜éœ€è¦å›æ»šï¼š

```bash
cd backend/src

# æ¢å¤åŸç‰ˆæœ¬
cp server.original.ts server.ts

# é‡å¯æœåŠ¡
# Ctrl+C ç„¶å pnpm run dev
```

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°æ— æ³•è§£å†³çš„é—®é¢˜ï¼š

1. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼ˆç»ˆç«¯è¾“å‡ºï¼‰
2. æ£€æŸ¥ `backend/.env` é…ç½®
3. è¿è¡Œ `ts-node test-security.ts` æŸ¥çœ‹è¯¦ç»†é”™è¯¯
4. æŸ¥çœ‹ Redisæ—¥å¿—ï¼š`redis-cli monitor`
